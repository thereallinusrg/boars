---
title: "Main_Notebook"
author: "Eric Tharmalingam & Linus RÃ¼egg"
date: "6/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("devtools") 
#devtools::install_github("ComputationalMovementAnalysis/ComputationalMovementAnalysisData")
#install.packages("simplevis")
library(simplevis)
library(ComputationalMovementAnalysisData)
#library(sf)
library(plyr)
library(dplyr)
library(sp)
library(rgdal) 
library(raster) 
```

## Taking a Look at the the Data & Import

```{r}
boars <- wildschwein_BE
head(boars)
```
Export as .csv
```{r}
# Optional, to take a look at the data with QGIS 
write.csv(boars, "boars.csv", row.names = FALSE)
```

# Step 1: Raster

Telling R that E and N are coordinate columns
```{r}
boars$E <- as.integer(boars$E)
boars$N <- as.integer(boars$N)
coordinates(boars) <- boars[,c(5, 6)]
```

Telling R that our points are in LV95 and check 
```{r}
proj4string(boars) <- CRS("+init=epsg:2056")
is.projected(boars)
```
Creating a Raster over the extend of our boar location points
```{r}
r <- raster(ext=extent(boars))

# Setting the raster cell size 
res(r) <- 1000
r
```
1000m results in 13*10 cells

Add raster coordinate info to column
```{r}
boars$raster_E <- ((boars$E - r@extent@xmin) %/% ((r@extent@xmax - r@extent@xmin)/ r@ncols)) # (Koordinate - Minimum Extent) // cellsize 
boars$raster_N <- ((boars$N - r@extent@ymin) %/% ((r@extent@ymax - r@extent@ymin)/ r@nrows))
```

# Step 2: Grid

Preparing to add a grid for each raster cell
```{r}
# Getting boundries for the loop
minE <- min(boars@data$raster_E)
maxE <- max(boars@data$raster_E)
minN <- min(boars@data$raster_N)
maxN <- max(boars@data$raster_N)

# Empty Vectors to be appended to in the loop, to add the grid Coordinates to the boars df after the loop ran
grid_E <- c()
grid_N <- c() 
```

Loop to create grid coordinates
```{r}
for (E_n in minE:maxE)
{
  for (N_n in minN:maxN)
  {
  
    # Doing the same as for the Raster now in every Raster cell (rcell), calling it Grid (g)
    rcell <- boars@data %>% filter(raster_E == E_n, raster_N == N_n)
    if (nrow(rcell)>1){ # Disregarding no or just single locations, as no strings can be built in those raster cells
      coordinates(rcell) <- rcell[,c(5, 6)]
      g <- raster(ext=extent(rcell))
      res(g) <- 50 # Setting the Grid resolution here, the 1000m Raster Cell is divided by this.
      rcell$grid_E <- ((rcell$E - g@extent@xmin) %/% ((g@extent@xmax - g@extent@xmin)/ g@ncols)) 
      rcell$grid_N <- ((rcell$N - g@extent@ymin) %/% ((g@extent@ymax - g@extent@ymin)/ g@nrows))
      grid_E <- append(grid_E,rcell$grid_E) 
      grid_N <- append(grid_N,rcell$grid_N)
    } else if (nrow(rcell)>0) { # Adding a 0 grid coordinate for raster cells with only 1 location (to preserve vector len)
      grid_E <- append(grid_E,0)
      grid_N <- append(grid_N,0)
    }
  }
}
```

Append grid coordinate vectors to the boars spdf
```{r}
boars@data$grid_E <- grid_E
boars@data$grid_N <- grid_N
```

# Step 3: Create Chess Strings per Raster Cell & Animal
```{r}
# Append all Information to a new DF containing our "Chess Strings"

# Creating empty df to later append to
empty_vector = c("Beispiel",0,0,"A1b2")
name_vector = c("TierName","raster_E","raster_N","ChessString")
#create a data frame out of a transposed vector
chess_boars = as.data.frame(t(empty_vector));
#change the names of the dataframe to be the titles
colnames(chess_boars) <- name_vector;

```

Creating the ChessStrings (This Loop takes a few seconds to run)
```{r}
for (E_n in minE:maxE)
{
  for (N_n in minN:maxN)
  {
    if (unique(boars@data$TierName)[1] > 0){
      for(name in unique(boars@data$TierName)){
        filter <- boars@data %>% filter(raster_E == E_n, raster_N == N_n, TierName == name)
        if (nrow(filter) >0) {
          filter$grid_E <- replace(filter$grid_E, filter$grid_E <1, 26) # setting -1 and 0 to z
          filter$grid_E <- replace(filter$grid_E, TRUE, letters[filter$grid_E]) # Turn Eastings into letters
          filter$coord <- paste(filter$grid_E, filter$grid_N, sep="") # Paste Eastings and Northings into one column
          
          coordf<- data.frame(filter$coord)
          ChessString <- paste(coordf[,1], collapse = "")
          
          supplemental_vector = c(name, E_n, N_n, ChessString)
          
          # Appending the Vector to the chess_boars df
          supplemental_data_frame <- data.frame(t(supplemental_vector));
          colnames(supplemental_data_frame) <- name_vector;
          chess_boars <- rbind(chess_boars, supplemental_data_frame);
        }
      }
    }
  }
}
```

```{r}
# Removing the row used to create the df
chess_boars <- chess_boars[-c(1),] 
```






